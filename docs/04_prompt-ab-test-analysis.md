# 프롬프트 A/B 테스트 결과 분석

## 개요

프롬프트 최적화를 위해 1단계(단어/숙어 추출)와 2단계(상세 정보 생성) 프롬프트의 10개 버전을 각각 10번씩 실행하여 성공률을 측정했습니다.

**테스트 일시**: 2025-11-26  
**테스트 결과 파일**:
- 1단계: `practice/phase4/ab_test_results_20251126_130814.json`
- 2단계: `practice/phase4/ab_test_results_20251126_143703.json`

---

## 1단계: 단어 및 숙어 추출 프롬프트 테스트

### 1.1 단어 추출 프롬프트 결과

| 버전 | 성공률 | 성공/실패 | 주요 특징 |
|------|--------|-----------|----------|
| v1 | 90% | 9/10 | 출력 형식 앞에 배치, 강한 강조 |
| v2 | 90% | 9/10 | 출력 형식 앞에 배치, 예시 포함 |
| v3 | 70% | 7/10 | 출력 형식 중간에 배치, 강한 강조 |
| v4 | 60% | 6/10 | 출력 형식 중간에 배치, 예시 포함 |
| v5 | 50% | 5/10 | 출력 형식 뒤에 배치, 강한 강조 |
| v6 | 50% | 5/10 | 출력 형식 뒤에 배치, 예시 포함 |
| v7 | 60% | 6/10 | 출력 형식 뒤에 배치, 간결한 강조 |
| v8 | 50% | 5/10 | 출력 형식 앞에 배치, 실패 예시 포함 |
| v9 | 60% | 6/10 | 출력 형식 중간에 배치, 실패 예시 포함 |
| **v10** | **100%** | **10/10** | **출력 형식 뒤에 배치, 간결한 강조** |

#### 선택된 버전: v10

**선택 이유**:
- **100% 성공률**: 10번 실행 모두 성공하여 가장 안정적
- **출력 형식 뒤에 배치**: 요구사항을 먼저 설명하고 마지막에 출력 형식을 제시하는 구조가 LLM이 더 잘 이해함
- **간결한 강조**: 과도한 강조 없이 핵심 사항만 명확히 제시

**v10 프롬프트 특징**:
- 요구사항을 먼저 설명
- 출력 형식을 마지막에 제시
- 간결하고 명확한 중요 사항 강조
- 마크다운 코드 블록 금지 명시

**실패한 버전들의 주요 문제점**:
- v1, v2: JSON 파싱 에러 (주석 포함, 중국어/프랑스어 혼용)
- v3-v9: JSON 파싱 에러, 구조 오류, 언어 혼용 등 다양한 문제 발생

---

### 1.2 숙어 추출 프롬프트 결과

| 버전 | 성공률 | 성공/실패 | 주요 특징 |
|------|--------|-----------|----------|
| **v1** | **100%** | **10/10** | **출력 형식 앞에 배치, 강한 강조** |
| **v2** | **100%** | **10/10** | **출력 형식 앞에 배치, 예시 포함** |
| v3 | 90% | 9/10 | 출력 형식 중간에 배치, 강한 강조 |
| **v4** | **100%** | **10/10** | **출력 형식 중간에 배치, 예시 포함** |
| **v5** | **100%** | **10/10** | **출력 형식 뒤에 배치, 강한 강조** |
| **v6** | **100%** | **10/10** | **출력 형식 뒤에 배치, 예시 포함** |
| **v7** | **100%** | **10/10** | **출력 형식 뒤에 배치, 간결한 강조** |
| **v8** | **100%** | **10/10** | **출력 형식 앞에 배치, 실패 예시 포함** |
| **v9** | **100%** | **10/10** | **출력 형식 중간에 배치, 실패 예시 포함** |
| **v10** | **100%** | **10/10** | **출력 형식 뒤에 배치, 간결한 강조 (v10 스타일)** |

#### 선택된 버전: v1

**선택 이유**:
- **100% 성공률**: 10번 실행 모두 성공
- **출력 형식 앞에 배치**: JSON 형식을 먼저 제시하여 LLM이 출력 형식을 명확히 인지
- **강한 강조**: 마크다운 코드 블록 금지 등 중요한 사항을 명확히 강조
- **간결함**: 불필요한 예시나 설명 없이 핵심만 제시

**v1 프롬프트 특징**:
- JSON 출력 형식을 프롬프트 맨 앞에 배치
- 마크다운 코드 블록 금지 명시
- 두 단어 이상 강제, 단일 단어 제외 명시
- 관용적 의미만 추출하도록 강조

**v3의 실패 사례**:
- 1회 실패: JSON 파싱 에러 (주석 포함)

---

## 2단계: 단어 및 숙어 상세 정보 생성 프롬프트 테스트

### 2.1 단어 상세 정보 생성 프롬프트 결과

| 버전 | 성공률 | 성공/실패 | 주요 특징 |
|------|--------|-----------|----------|
| **v1** | **100%** | **10/10** | **출력 형식 앞에 배치, 강한 강조** |
| **v2** | **100%** | **10/10** | **출력 형식 앞에 배치, 예시 포함** |
| v3 | 0% | 0/10 | 출력 형식 중간에 배치, 강한 강조 |
| v4 | 0% | 0/10 | 출력 형식 중간에 배치, 예시 포함 |
| v5 | 70% | 7/10 | 출력 형식 뒤에 배치, 강한 강조 |
| v6 | 0% | 0% | 출력 형식 뒤에 배치, 예시 포함 |
| **v7** | **100%** | **10/10** | **출력 형식 뒤에 배치, 간결한 강조** |
| **v8** | **100%** | **10/10** | **출력 형식 앞에 배치, 실패 예시 포함** |
| v9 | 90% | 9/10 | 출력 형식 중간에 배치, 실패 예시 포함 |
| v10 | 70% | 7/10 | 출력 형식 뒤에 배치, 간결한 강조 (v10 스타일) |

#### 선택된 버전: v1, v7 (재시도 로직에 사용)

**선택 이유**:
- **v1과 v7 모두 100% 성공률**: 가장 안정적
- **v1**: 출력 형식 앞에 배치로 LLM이 형식을 먼저 인지
- **v7**: 출력 형식 뒤에 배치로 요구사항을 먼저 이해한 후 형식 적용
- **재시도 로직**: v1 → v7 → v1 → v7 순서로 최대 4번 시도하여 안정성 향상

**v1 프롬프트 특징**:
- JSON 출력 형식을 프롬프트 맨 앞에 배치
- 마크다운 코드 블록 금지 명시
- 동의어 최대 2개, 예문 1개 명시

**v7 프롬프트 특징**:
- 요구사항을 먼저 설명
- 출력 형식을 마지막에 제시
- 간결하고 명확한 중요 사항 강조

**실패한 버전들의 주요 문제점**:
- v3: `videoId` 누락 (모든 실행 실패)
- v4, v6: JSON 파싱 에러, 영어 키 사용 (`synonyms`, `example` 대신 `동의어`, `예문` 사용해야 함)
- v5, v10: 일부 실행에서 `videoId` 누락
- v9: 1회 실패 (videoId 누락)

---

### 2.2 숙어 예문 생성 프롬프트 결과

| 버전 | 성공률 | 성공/실패 | 주요 특징 |
|------|--------|-----------|----------|
| **v1** | **100%** | **10/10** | **출력 형식 앞에 배치, 강한 강조** |
| **v2** | **100%** | **10/10** | **출력 형식 앞에 배치, 예시 포함** |
| **v3** | **100%** | **10/10** | **출력 형식 중간에 배치, 강한 강조** |
| v4 | 0% | 0/10 | 출력 형식 중간에 배치, 예시 포함 |
| **v5** | **100%** | **10/10** | **출력 형식 뒤에 배치, 강한 강조** |
| v6 | 0% | 0/10 | 출력 형식 뒤에 배치, 예시 포함 |
| **v7** | **100%** | **10/10** | **출력 형식 뒤에 배치, 간결한 강조** |
| **v8** | **100%** | **10/10** | **출력 형식 앞에 배치, 실패 예시 포함** |
| **v9** | **100%** | **10/10** | **출력 형식 중간에 배치, 실패 예시 포함** |
| **v10** | **100%** | **10/10** | **출력 형식 뒤에 배치, 간결한 강조 (v10 스타일)** |

#### 선택된 버전: v1, v7 (재시도 로직에 사용)

**선택 이유**:
- **v1과 v7 모두 100% 성공률**: 가장 안정적
- **v1**: 출력 형식 앞에 배치로 LLM이 형식을 먼저 인지
- **v7**: 출력 형식 뒤에 배치로 요구사항을 먼저 이해한 후 형식 적용
- **재시도 로직**: v1 → v7 → v1 → v7 순서로 최대 4번 시도하여 안정성 향상

**v1 프롬프트 특징**:
- JSON 출력 형식을 프롬프트 맨 앞에 배치
- 마크다운 코드 블록 금지 명시
- 예문 1개 명시

**v7 프롬프트 특징**:
- 요구사항을 먼저 설명
- 출력 형식을 마지막에 제시
- 간결하고 명확한 중요 사항 강조

**실패한 버전들의 주요 문제점**:
- v4, v6: `videoId` 누락 (모든 실행 실패)

---

## 최종 선택 결과

### 실제 적용된 프롬프트 버전

| 단계 | 모듈 | 선택된 버전 | 재시도 로직 |
|------|------|------------|------------|
| 1단계 | 단어 추출 | **v10** | 없음 (100% 성공률) |
| 1단계 | 숙어 추출 | **v1** | 없음 (100% 성공률) |
| 2단계 | 단어 상세 정보 생성 | **v1, v7** | v1 → v7 → v1 → v7 (최대 4번) |
| 2단계 | 숙어 예문 생성 | **v1, v7** | v1 → v7 → v1 → v7 (최대 4번) |

### 재시도 로직 구현 이유

2단계 프롬프트에서 재시도 로직을 구현한 이유:
1. **1단계와의 차이점**: 1단계는 청크별로 처리하므로 일부 실패해도 성공한 청크의 결과를 사용할 수 있음
2. **2단계의 특성**: 2단계는 1단계 결과를 한 번에 처리하므로 한 번 실패하면 전체 결과를 얻을 수 없음
3. **안정성 향상**: v1과 v7을 번갈아가며 최대 4번 시도하여 성공 확률을 높임

---

## 주요 발견 사항

### 1. 출력 형식 배치 위치의 영향

- **앞에 배치 (v1, v2)**: JSON 형식을 먼저 제시하여 LLM이 출력 형식을 명확히 인지
- **뒤에 배치 (v7, v10)**: 요구사항을 먼저 설명하고 마지막에 형식을 제시하여 LLM이 요구사항을 이해한 후 형식 적용
- **결과**: 두 방식 모두 효과적이지만, 프롬프트의 복잡도와 요구사항에 따라 다름

### 2. 마크다운 코드 블록 금지의 중요성

- 모든 실패 사례에서 마크다운 코드 블록(```json ... ```)을 포함한 응답이 발생
- 명시적인 금지 지시가 있어도 일부 버전에서는 여전히 발생
- **해결책**: `app/services/llm/client.py`에서 자동으로 마크다운 코드 블록 제거 로직 추가

### 3. JSON 키 이름의 중요성

- 2단계 프롬프트에서 영어 키(`synonyms`, `example`) 대신 한국어 키(`동의어`, `예문`)를 사용해야 함
- v4, v6 버전에서 영어 키를 사용하여 JSON 파싱 실패 발생

### 4. videoId 필드의 중요성

- 모든 프롬프트 버전에서 최상위 레벨에 `videoId` 필드가 필수
- v3, v4, v6 버전에서 `videoId` 누락으로 인한 실패 발생

### 5. 언어 혼용 문제

- 일부 버전에서 중국어, 프랑스어 등 다른 언어가 혼용됨
- 명시적인 "한국어로만" 지시가 필요

---

## 결론

A/B 테스트를 통해 각 단계별로 최적의 프롬프트 버전을 선택했으며, 2단계에서는 재시도 로직을 구현하여 안정성을 높였습니다. 선택된 프롬프트 버전들은 모두 100% 성공률을 달성하여 프로덕션 환경에서 안정적으로 사용할 수 있습니다.

**다음 단계**:
- 선택된 프롬프트 버전을 `app/services/llm/prompts.py`에 반영 완료
- 재시도 로직을 `app/services/llm/enrich_words.py`, `app/services/llm/enrich_phrases.py`에 구현 완료
- 향후 프롬프트 수정 시 이 문서를 참고하여 유사한 패턴을 유지

